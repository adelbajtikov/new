<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
    <link rel="stylesheet" href="/static/css/profile.css">
    <!--<link rel="stylesheet" href="/static/css/styles.css"> -->
</head>
<body>

    <!-- üîπ HEADER -->
    <header class="header">
        <div class="header-container">
            <!-- –õ–æ–≥–æ—Ç–∏–ø -->
            <div class="logo">
                <img src="/static/images/logo.png" alt="Alterra" class="logo-img">
                <span class="logo-text">Alterra</span>
            </div>

            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
            <nav class="nav">
                <a href="{{ url_for('home') }}">–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è</a>
                <a href="{{ url_for('volunteering') }}">–í–æ–ª–æ–Ω—Ç—ë—Ä—Å—Ç–≤–∞</a>
                <a href="{{ url_for('organizations') }}">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</a>
            </nav>

            <!-- –ê–≤–∞—Ç–∞—Ä –∏ –≤—ã—Ö–æ–¥ -->
            <div class="user-profile">
                {% if session.get('user_id') %}
                    <a href="{{ url_for('profile') }}">
                        <img src="{{ user['avatar'] if user['avatar'] else '/static/images/default_avatar.png' }}" class="user-avatar">
                    </a>
                    <a href="{{ url_for('logout') }}" class="logout-link">–í—ã–π—Ç–∏</a>
                {% else %}
                    <a href="{{ url_for('login') }}">
                        <img src="/static/images/user.png" alt="–ì–æ—Å—Ç—å" class="user-avatar">
                    </a>
                {% endif %}
            </div>
        </div>
    </header>
    <!-- üîπ PROFILE CONTENT -->
    <div class="profile-container">
        <h1>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>


        <!-- ‚úÖ 1. –ê–≤–∞—Ç–∞—Ä –∏ —Å–º–µ–Ω–∞ —Ñ–æ—Ç–æ -->
        <div class="profile-avatar-container">
            <img src="{{ user.avatar if user.avatar else '/static/images/default_avatar.png' }}" class="profile-avatar">
            <form action="{{ url_for('update_avatar') }}" method="POST" enctype="multipart/form-data">
                <input type="file" name="avatar" accept=".png, .jpg, .jpeg, .gif" required>
                <button type="submit" class="btn">–û–±–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ç–æ</button>
            </form>
        </div>


        <!-- ‚úÖ 2. –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <p><strong>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> {{ user.username }}</p>
        <p><strong>–í–∞—à–∏ –±–∞–ª–ª—ã:</strong> {{ user.points if user.points else 0 }} üèÜ</p>
       
        <a href="{{ url_for('create_campaign') }}" class="btn">–°–æ–∑–¥–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é</a>


        <h2>–í–∞—à–∏ –∫–∞–º–ø–∞–Ω–∏–∏</h2>
        {% if campaigns %}
            <div class="campaign-container">
                {% for campaign in campaigns %}
                <div class="campaign-card">
                    <img src="{{ campaign.image_url }}" alt="{{ campaign.title }}" class="campaign-image">
                    <div class="campaign-content">
                        <h3>{{ campaign.title }}</h3>
                        <p>{{ campaign.description[:100] }}...</p> <!-- –ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ -->
                        <p>–°–æ–±—Ä–∞–Ω–æ: ${{ campaign.collected }} / ${{ campaign.goal }}</p>
                        <div class="progress-bar">
                            <div style="width: {{ (campaign.collected / campaign.goal) * 100 }}%;"></div>
                        </div>
                        <a href="{{ url_for('donate', campaign_id=campaign['id']) }}" class="btn">–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å</a>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p>–í—ã –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–ª–∏ –Ω–∏ –æ–¥–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏.</p>
        {% endif %}
        <!-- üîπ –ö–Ω–æ–ø–∫–∞ "–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π" -->
        <button class="btn" onclick="openPaymentsModal()">–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</button>


        <!-- üîπ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π" -->
        <div id="paymentsModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closePaymentsModal()">&times;</span>
                <h2>–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</h2>
               
                <!-- üîπ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ —Å–∫—Ä–æ–ª–ª–æ–º -->
                <div class="payments-container">
                    <table class="payments-table">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–ö–∞–º–ø–∞–Ω–∏—è</th>
                                <th>–°—É–º–º–∞ ($)</th>
                                <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsList">
                            <!-- üõ†Ô∏è –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- üîπ –ö–ù–û–ü–ö–ê –°–û–ó–î–ê–ù–ò–Ø –í–û–õ–û–ù–¢–Å–†–°–ö–û–ô –ê–ö–¶–ò–ò -->
        <a href="{{ url_for('create_volunteering') }}" class="btn create-btn">–°–æ–∑–¥–∞—Ç—å –≤–æ–ª–æ–Ω—Ç—ë—Ä—Å–∫—É—é –∞–∫—Ü–∏—é</a>
       


        <!-- ‚úÖ 4. –£—á–∞—Å—Ç–∏–µ –≤ –≤–æ–ª–æ–Ω—Ç—ë—Ä—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö -->
        <h2>–í–∞—à–∏ –≤–æ–ª–æ–Ω—Ç—ë—Ä—Å–∫–∏–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã</h2>


        {% if volunteer_initiatives %}
            <div class="volunteer-grid">
                {% for initiative in volunteer_initiatives %}
                <div class="volunteer-card">
                    <div class="volunteer-content">
                        <h3>{{ initiative.title }}</h3>
                        <p>{{ initiative.description[:120] }}...</p>
                        <p><strong>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> {{ initiative.participant_count }}</p>
                       
                        <!-- üîπ –ö–ù–û–ü–ö–ê "–ü–û–°–ú–û–¢–†–ï–¢–¨ –£–ß–ê–°–¢–ù–ò–ö–û–í" -->
                        <button class="btn view-participants" onclick="openParticipantsModal({{ initiative.id }})">
                            –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-volunteer-projects">
                <p>–í—ã –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–ª–∏ –Ω–∏ –æ–¥–Ω–æ–π –≤–æ–ª–æ–Ω—Ç—ë—Ä—Å–∫–æ–π –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã.</p>
            </div>
        {% endif %}
       
        <!-- üîπ –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –°–ü–ò–°–ö–ê –£–ß–ê–°–¢–ù–ò–ö–û–í -->
        <div id="participantsModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeParticipantsModal()">&times;</span>
                <h2>–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h2>
                <ul id="participantsList"></ul>
            </div>
        </div>
   
        <h2>–ú–æ–∏ —É—á–∞—Å—Ç–∏—è –≤ –≤–æ–ª–æ–Ω—Ç–µ—Ä—Å–∫–∏—Ö –∞–∫—Ü–∏—è—Ö</h2>
        {% if participated_opportunities %}
            <div class="volunteering-block">
                {% for opportunity in participated_opportunities %}
                <div class="volunteer-card">
                    <div class="volunteer-header">
                        <h3>{{ opportunity.title }}</h3>
                        <p class="volunteer-date"><strong>–î–∞—Ç–∞:</strong> {{ opportunity.date }}</p>
                    </div>
                    <p>{{ opportunity.description }}</p>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-opportunities">
                <p>–í—ã –ø–æ–∫–∞ –Ω–µ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª–∏ –≤ –≤–æ–ª–æ–Ω—Ç—ë—Ä—Å–∫–∏—Ö –∞–∫—Ü–∏—è—Ö.</p>
            </div>
        {% endif %}
       
        <h2>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏</h2>
        <div id="recommended-campaigns"></div>


        <!-- ‚úÖ 6. –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ -->
       
        <h2>–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–ª–æ–Ω—Ç—ë—Ä—Å–∫–∏–µ –∞–∫—Ü–∏–∏</h2>
        <div id="recommended-volunteering"></div>


        <script>
        function loadRecommendations() {
            let campaignId = {{ campaigns[0].id if campaigns else 'null' }};
            if (campaignId === 'null') return; // –ï—Å–ª–∏ –Ω–µ—Ç –∫–∞–º–ø–∞–Ω–∏–π ‚Äî –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

            fetch(`/recommend_campaigns/${campaignId}`)
                .then(response => response.json())
                .then(data => {
                    let container = document.getElementById("recommended-campaigns");
                    container.innerHTML = "";
                    if (data.length > 0) {
                        data.forEach(campaign => {
                            let campaignCard = `
                                <div class="campaign-card">
                                    <h3>${campaign.title}</h3>
                                    <p>${campaign.description}</p>
                                    <a href="/donate/${campaign.id}" class="btn">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                                </div>
                            `;
                            container.innerHTML += campaignCard;
                        });
                    } else {
                        container.innerHTML = "<p>–ù–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π.</p>";
                    }
                })
                .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:", error));
        }

        // üîπ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–æ–ª–æ–Ω—Ç—ë—Ä—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º
        function loadRecommendedVolunteering() {
            let opportunityId = {{ participated_opportunities[0].id if participated_opportunities else 'null' }};
            if (opportunityId === 'null') return; // –ï—Å–ª–∏ –Ω–µ—Ç —É—á–∞—Å—Ç–∏–π, –Ω–µ –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å

            fetch(`/recommend_volunteering/${opportunityId}`)
                .then(response => response.json())
                .then(data => {
                    let container = document.getElementById("recommended-volunteering");
                    container.innerHTML = "";
                    if (data.length > 0) {
                        data.forEach(opportunity => {
                            let opportunityCard = `
                                <div class="volunteer-card">
                                    <h3>${opportunity.title}</h3>
                                    <p>${opportunity.description}</p>
                                    <a href="/volunteering/${opportunity.id}" class="btn">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                                </div>
                            `;
                            container.innerHTML += opportunityCard;
                        });
                    } else {
                        container.innerHTML = "<p>–ù–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã—Ö –∞–∫—Ü–∏–π.</p>";
                    }
                })
                .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–æ–ª–æ–Ω—Ç—ë—Ä—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:", error));
        }
        function openDonationsModal() {
        document.getElementById("donationsModal").style.display = "flex";
        }

        function closeDonationsModal() {
            document.getElementById("donationsModal").style.display = "none";
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏
        loadRecommendations();
        loadRecommendedVolunteering();
        function openPaymentsModal() {
            fetch('/get_payment_history')  // ‚ö° –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–ª–∞—Ç–µ–∂–µ–π
                .then(response => response.json())
                .then(data => {
                    let paymentsList = document.getElementById("paymentsList");
                    paymentsList.innerHTML = ""; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

                    if (data.length > 0) {
                        data.forEach(payment => {
                            let row = `
                                <tr>
                                    <td>${payment.date}</td>
                                    <td>${payment.campaign_title}</td>
                                    <td>$${payment.amount}</td>
                                    <td>${payment.message || '-'}</td>
                                </tr>
                            `;
                            paymentsList.innerHTML += row;
                        });
                    } else {
                        paymentsList.innerHTML = "<tr><td colspan='4'>–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –ø—É—Å—Ç–∞</td></tr>";
                    }

                    document.getElementById("paymentsModal").style.display = "block"; // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
                })
                .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–ª–∞—Ç–µ–∂–µ–π:", error));
        }

        // üîπ –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closePaymentsModal() {
            document.getElementById("paymentsModal").style.display = "none";
        }
        function openParticipantsModal(opportunityId) {
        fetch(`/get_participants/${opportunityId}`)
            .then(response => response.json())
            .then(data => {
                let participantsList = document.getElementById("participantsList");
                participantsList.innerHTML = ""; // –û—á–∏—Å—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

                if (data.length > 0) {
                    data.forEach(participant => {
                        let listItem = document.createElement("li");
                        listItem.textContent = participant.username;
                        participantsList.appendChild(listItem);
                    });
                } else {
                    participantsList.innerHTML = "<li>–ü–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</li>";
                }

                document.getElementById("participantsModal").style.display = "block";
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:", error));
    }

    function closeParticipantsModal() {
        document.getElementById("participantsModal").style.display = "none";
    }


    </script>
    </div>

</body>
</html>
